#!/bin/bash
# info: Make a snapshot of the disk usage
# options: NONE

folder="/usr/local/vesta/data/df"

mkdir -p $folder
timestamp=$(date +%Y-%m-%d-%H-%M-%S)

du --max-depth=1 -m -x / > $folder/snapshot-$timestamp.txt

du --max-depth=6 -m -x /home > $folder/snapshot-temp.txt
for i in {2..7}; do
    while IFS= read -r line; do
        count=0
        for (( j=0; j<${#line}; j++ )); do
            if [[ ${line:j:1} == "/" ]]; then
                ((count++))
            fi
        done
        if [ $count -eq $i ]; then
            printf '%s\n' "$line" >> $folder/snapshot-$timestamp.txt
        fi
    done < $folder/snapshot-temp.txt
done
rm $folder/snapshot-temp.txt

if [ -d "/hdd" ]; then
    du --max-depth=7 -m -x /hdd > $folder/snapshot-temp.txt
    for i in {1..8}; do
        while IFS= read -r line; do
            count=0
            for (( j=0; j<${#line}; j++ )); do
                if [[ ${line:j:1} == "/" ]]; then
                    ((count++))
                fi
            done
            if [ $count -eq $i ]; then
                printf '%s\n' "$line" >> $folder/snapshot-$timestamp.txt
            fi
        done < $folder/snapshot-temp.txt
    done
    rm $folder/snapshot-temp.txt
fi

du --max-depth=1 -m -x /var/lib/mysql >> $folder/snapshot-$timestamp.txt
du --max-depth=1 -m -x /var/log >> $folder/snapshot-$timestamp.txt

chmod 600 $folder/snapshot-$timestamp.txt
chown root:root $folder/snapshot-$timestamp.txt

exit 0
